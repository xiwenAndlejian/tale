<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

<p>
</p>
<p>
</p>
<p>
</p>
<p>
</p>
<p>
</p>
<p class="post-tags"></p>
<p>
</p>
<h1 id="directory0221050336397428551">Sqlite转MySQL（一）建表语句&amp;Java源码修改</h1>
<p>为什么想要使用MySQL：由于Sqlite表无法实现远程网络访问，实时数据查询起来极其不方便，因此修改数据库为MySQL。<br data-mce-bogus="1"></p>
<h2 id="directory0221050336397428552">建表语句</h2>
<p>而Sqlite与MySQL的有部分检表语句并不通用，需要修改一下才能使用对应的源码。</p>
<p>如下表作为例子表示tale建表语句中中Sqlite和MySQL的区别<br data-mce-bogus="1"></p>
<p><strong>Sqlite</strong></p>
<pre class=" language-sql" contenteditable="false">CREATE TABLE t_attach (
  id        INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL, #Sqlite 中AUTOINCREMENT表示自增长，不与MySQL中通用
};
...
CREATE TALBE t_users (
  ﻿uid INTEGER UNSIGNED PRIMARY KEY AUTOINCREMENT NOT NULL #由于JAVA源码中没有生成主键，需要设置主键为自增长
);</pre>
<p><strong>MySQL</strong>﻿</p>
<pre class="language-sql" contenteditable="false">CREATE TABLE t_attach (
  id        INTEGER PRIMARY KEY AUTO_INCREMENT NOT NULL,
  ...
);
...
CREATE TALBE t_users (
  ﻿uid INTEGER UNSIGNED PRIMARY KEY AUTO_INCREMENT NOT NULL,
  ...﻿
);</pre>
<p><code></code></p>
<h2 id="directory0221050336397428553">源码修改</h2>
<p><b>WebContext.java(修改):</b><br></p>
<pre class=" language-java" contenteditable="false">@Override
<span class="token keyword">public</span> <span class="token keyword">void</span> <span
            class="token function">preHandle</span><span class="token punctuation">(</span>Blade blade<span
            class="token punctuation">)</span> <span class="token punctuation">{</span>
    Ioc ioc <span class="token operator">=</span> blade<span class="token punctuation">.</span><span
            class="token function">ioc</span><span class="token punctuation">(</span><span
            class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> devMode <span class="token operator">=</span> <span
            class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>blade<span
            class="token punctuation">.</span><span class="token function">environment</span><span
            class="token punctuation">(</span><span class="token punctuation">)</span><span
            class="token punctuation">.</span><span class="token function">hasKey</span><span class="token punctuation">(</span><span
            class="token string">"app.dev"</span><span class="token punctuation">)</span><span
            class="token punctuation">)</span> <span class="token punctuation">{</span>
        devMode <span class="token operator">=</span> blade<span class="token punctuation">.</span><span
            class="token function">environment</span><span class="token punctuation">(</span><span
            class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBoolean</span><span
            class="token punctuation">(</span><span class="token string">"app.dev"</span><span
            class="token punctuation">,</span> <span class="token boolean">true</span><span
            class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>blade<span
            class="token punctuation">.</span><span class="token function">environment</span><span
            class="token punctuation">(</span><span class="token punctuation">)</span><span
            class="token punctuation">.</span><span class="token function">hasKey</span><span class="token punctuation">(</span><span
            class="token string">"app.devMode"</span><span class="token punctuation">)</span><span
            class="token punctuation">)</span> <span class="token punctuation">{</span>
        devMode <span class="token operator">=</span> blade<span class="token punctuation">.</span><span
            class="token function">environment</span><span class="token punctuation">(</span><span
            class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBoolean</span><span
            class="token punctuation">(</span><span class="token string">"app.devMode"</span><span
            class="token punctuation">,</span> <span class="token boolean">true</span><span
            class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    DBInit<span class="token punctuation">.</span><span class="token function">jdbcConnTest</span><span
            class="token punctuation">(</span>blade<span class="token punctuation">.</span><span class="token function">environment</span><span
            class="token punctuation">(</span><span class="token punctuation">)</span><span
            class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//TODO 初始化数据实现</span>
	<span class="token comment" spellcheck="true">//SqliteJdbc.importSql(devMode);</span>
	<span class="token comment" spellcheck="true">//Sql2o sql2o = new Sql2o(SqliteJdbc.DB_SRC, null, null);</span>
    <span class="token comment" spellcheck="true">//更换了sql2o的创建参数，具体见下</span>
    Sql2o sql2o <span class="token operator">=</span> <span class="token keyword">new</span> <span
            class="token class-name">Sql2o</span><span class="token punctuation">(</span>DBInit<span
            class="token punctuation">.</span>url<span class="token punctuation">,</span> DBInit<span
            class="token punctuation">.</span>user<span class="token punctuation">,</span> DBInit<span
            class="token punctuation">.</span>password<span class="token punctuation">)</span><span
            class="token punctuation">;</span>
    Base<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>sql2o<span
            class="token punctuation">)</span><span class="token punctuation">;</span>
    Commons<span class="token punctuation">.</span><span class="token function">setSiteService</span><span
            class="token punctuation">(</span>ioc<span class="token punctuation">.</span><span class="token function">getBean</span><span
            class="token punctuation">(</span>SiteService<span class="token punctuation">.</span><span
            class="token keyword">class</span><span class="token punctuation">)</span><span
            class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre>
<p><strong>DBInit.java(新增):</strong><br></p>
<pre class="language-java" contenteditable="false"><span class="token keyword">package</span> com<span
        class="token punctuation">.</span>tale<span class="token punctuation">.</span>init<span
        class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>blade<span
            class="token punctuation">.</span>Environment<span class="token punctuation">;</span>
<span class="token keyword">import</span> lombok<span class="token punctuation">.</span>NoArgsConstructor<span
            class="token punctuation">;</span>
<span class="token keyword">import</span> lombok<span class="token punctuation">.</span>extern<span
            class="token punctuation">.</span>slf4j<span class="token punctuation">.</span>Slf4j<span
            class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>sql<span
            class="token punctuation">.</span>Connection<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>sql<span
            class="token punctuation">.</span>DriverManager<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * 标题：DBInit&lt;br&gt;
 * 功能说明：数据库初始化&lt;br&gt;
 * 系统版本：v1.0&lt;br&gt;
 * 开发人员： ganxiang &lt;br&gt;
 * 开发时间：2018年01月08日 22:24&lt;br&gt;
 */</span>
@Slf4j
@NoArgsConstructor
<span class="token keyword">public</span> <span class="token keyword">class</span> <span
            class="token class-name">DBInit</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> String className<span
            class="token punctuation">;</span> <span class="token comment" spellcheck="true">//数据库驱动类名</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> String user<span
            class="token punctuation">;</span>      <span class="token comment" spellcheck="true">//数据库用户名</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> String password<span
            class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//密码</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> String url<span
            class="token punctuation">;</span>       <span class="token comment" spellcheck="true">//数据库连接url（此项需要包含utf-8设置，否则容易乱码）</span>

    <span class="token comment" spellcheck="true">/**
     * jdbc连接测试
     *
     * @param environment 服务设置
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span
            class="token keyword">void</span> <span class="token function">jdbcConnTest</span><span
            class="token punctuation">(</span>Environment environment<span class="token punctuation">)</span> <span
            class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            className <span class="token operator">=</span> environment<span class="token punctuation">.</span><span
            class="token function">get</span><span class="token punctuation">(</span><span class="token string">"jdbc.driverClassName"</span><span
            class="token punctuation">,</span> <span class="token string">"com.mysql.jdbc.Driver"</span><span
            class="token punctuation">)</span><span class="token punctuation">;</span>
            user <span class="token operator">=</span> environment<span class="token punctuation">.</span><span
            class="token function">get</span><span class="token punctuation">(</span><span class="token string">"jdbc.user"</span><span
            class="token punctuation">,</span> <span class="token string">"tale"</span><span
            class="token punctuation">)</span><span class="token punctuation">;</span>
            password <span class="token operator">=</span> environment<span class="token punctuation">.</span><span
            class="token function">get</span><span class="token punctuation">(</span><span class="token string">"jdbc.password"</span><span
            class="token punctuation">,</span> <span class="token string">"123456"</span><span
            class="token punctuation">)</span><span class="token punctuation">;</span>
            url <span class="token operator">=</span> environment<span class="token punctuation">.</span><span
            class="token function">get</span><span class="token punctuation">(</span><span class="token string">"jdbc.url"</span><span
            class="token punctuation">,</span> <span class="token string">"jdbc:mysql://127.0.0.1:3306/tale?useUnicode=true&amp;characterEncoding=UTF-8"</span><span
            class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">//加载驱动类</span>
            Class<span class="token punctuation">.</span><span class="token function">forName</span><span
            class="token punctuation">(</span>className<span class="token punctuation">)</span><span
            class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//获取连接</span>
            Connection con <span class="token operator">=</span>
                    DriverManager<span class="token punctuation">.</span><span
            class="token function">getConnection</span><span class="token punctuation">(</span>url<span
            class="token punctuation">,</span> user<span class="token punctuation">,</span> password<span
            class="token punctuation">)</span><span class="token punctuation">;</span>

            log<span class="token punctuation">.</span><span class="token function">info</span><span
            class="token punctuation">(</span><span class="token string">"db schema:"</span><span
            class="token punctuation">,</span> con<span class="token punctuation">.</span><span class="token function">getSchema</span><span
            class="token punctuation">(</span><span class="token punctuation">)</span><span
            class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span
            class="token punctuation">(</span><span class="token class-name">Exception</span> e<span
            class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span
            class="token punctuation">(</span><span class="token string">"load dataSource error :"</span><span
            class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre>
<p><br></p>
<p>
</p>
<p>
</p>
<p>
</p>
<p>
</p>
<p>
</p>
<p>至此：我们已经修改了系统内部sql2o的创建方式，但仍需针对MySQL增加相应配置项才能启动，详细介绍见下文。</p>
</body>
</html>